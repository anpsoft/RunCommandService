#!/bin/bash

# –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ app.ini
PACKAGE=$(grep "^package=" app.ini | cut -d'=' -f2)
APP_NAME=$(grep "^appName=" app.ini | cut -d'=' -f2)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç
if [ -z "$PACKAGE" ] || [ -z "$APP_NAME" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: package –∏–ª–∏ appName –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ app.ini"
    exit 1
fi

echo "üìä –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:"
echo "PACKAGE=$PACKAGE"
echo "APP_NAME=$APP_NAME"

# –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
cat << EOF > app/src/main/AndroidManifest.xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="$PACKAGE">
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="com.android.launcher.permission.INSTALL_SHORTCUT"/>
    <uses-permission android:name="com.android.launcher.permission.UNINSTALL_SHORTCUT" />
    <uses-permission android:name="com.termux.permission.RUN_COMMAND"/>
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="$APP_NAME"
        android:theme="@android:style/Theme.DeviceDefault.Light">
EOF

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∏–∑ app.ini
activities=$(awk '/^\[.*Activity\]/{print substr($0,2,length($0)-2)}' app.ini)

# –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
for activity in $activities; do
    enabled=$(awk "/^\[$activity\]/{flag=1; next} /^\[/{flag=0} flag && /^enabled=/{print \$0}" app.ini | cut -d'=' -f2)
    theme=$(awk "/^\[$activity\]/{flag=1; next} /^\[/{flag=0} flag && /^theme=/{print \$0}" app.ini | cut -d'=' -f2)
    exported=$(awk "/^\[$activity\]/{flag=1; next} /^\[/{flag=0} flag && /^exported=/{print \$0}" app.ini | cut -d'=' -f2)
    intentFilter=$(awk "/^\[$activity\]/{flag=1; next} /^\[/{flag=0} flag && /^intentFilter=/{print \$0}" app.ini | cut -d'=' -f2)
    enabled=${enabled:-"false"}
    theme=${theme:-"DeviceDefault.Light"}
    exported=${exported:-"false"}
    intentFilter=${intentFilter:-"NONE"}
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º $activity: enabled=$enabled, theme=$theme, exported=$exported, intentFilter=$intentFilter"
    if [ "$enabled" = "true" ]; then
        if [ "$exported" = "true" ] && [ "$intentFilter" = "SHORTCUT" ]; then
            cat << EOF >> app/src/main/AndroidManifest.xml
        <activity
            android:name=".$activity"
            android:exported="$exported"
            android:enabled="$enabled"
            android:theme="@android:style/Theme.$theme">
            <intent-filter>
                <action android:name="android.intent.action.CREATE_SHORTCUT" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>
EOF
        elif [ "$exported" = "true" ] && [ "$intentFilter" = "MAIN" ]; then
            cat << EOF >> app/src/main/AndroidManifest.xml
        <activity
            android:name=".$activity"
            android:exported="$exported"
            android:enabled="$enabled"
            android:theme="@android:style/Theme.$theme">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
EOF
        else
            cat << EOF >> app/src/main/AndroidManifest.xml
        <activity
            android:name=".$activity"
            android:exported="$exported"
            android:enabled="$enabled"
            android:theme="@android:style/Theme.$theme" />
EOF
        fi
        echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ç–∏: $activity (.$activity)"
    else
        echo "‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ç–∏: $activity (enabled=$enabled)"
    fi
done

cat << EOF >> app/src/main/AndroidManifest.xml
    </application>
</manifest>
EOF

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ XML –∏–∑ templates/layout/
if [ -d "templates/layout" ]; then
    for xml_file in $(find templates/layout -name "*.xml"); do
        xml_name=$(basename "$xml_file")
        cp "$xml_file" "app/src/main/res/layout/$xml_name"
        echo "‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω: $xml_name –≤ layout"
    done
fi
echo "‚úÖ –†–µ—Å—É—Ä—Å—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã"

# –í—ã–≤–æ–¥–∏–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –≤ –ª–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
echo "üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AndroidManifest.xml:"
echo "=================================="
cat app/src/main/AndroidManifest.xml
echo "=================================="
echo "‚úÖ AndroidManifest.xml —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"